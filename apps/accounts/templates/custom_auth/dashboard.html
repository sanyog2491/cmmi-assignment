<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="container">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="upload-tab" data-toggle="tab" href="#upload-data" role="tab" aria-controls="upload-data" aria-selected="true">Upload Data</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="query-tab" data-toggle="tab" href="#query-builder" role="tab" aria-controls="query-builder" aria-selected="false">Query Builder</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="users-tab" data-toggle="tab" href="#users" role="tab" aria-controls="users" aria-selected="false">Users</a>
            </li>
            <li class="nav-item ml-auto">
                <a class="nav-link" href="{% url 'account_logout' %}">Logout</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Upload Data Section -->
            <div class="tab-pane fade show active" id="upload-data" role="tabpanel" aria-labelledby="upload-tab">
                <h2>Upload Data</h2>
                <form id="upload-form" action="{% url 'file-upload' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <input type="file" name="data_file" class="form-control-file">
                    </div>
                    <button type="submit" class="btn btn-primary">Start Upload</button>
                </form>
                <div id="progress-bar" class="progress" style="display: none;">
                    <div class="progress-bar" role="progressbar"></div>
                </div>
            </div>

            <!-- Query Builder Section -->
            <div class="tab-pane fade" id="query-builder" role="tabpanel" aria-labelledby="query-tab">
                <h2>Query Builder</h2>
                <form id="query-form">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="keyword">Keyword</label>
                            <input type="text" name="keyword" class="form-control" id="keyword">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="industry">Industry</label>
                            <select name="industry" class="form-control" id="industry">
                                <option>Select</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="year">Year Founded</label>
                            <input type="number" name="year" class="form-control" id="year">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="city">City</label>
                            <select name="city" class="form-control" id="city">
                                <option value="">Select City</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="state">State</label>
                            <select name="state" class="form-control" id="state">
                                <option value="">Select State</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="country">Country</label>
                            <select name="country" class="form-control" id="country">
                                <option value="">Select Country</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="employees_from">Employees (From)</label>
                            <input type="number" name="employees_from" class="form-control" id="employees_from">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="employees_to">Employees (To)</label>
                            <input type="number" name="employees_to" class="form-control" id="employees_to">
                        </div>
                    </div>
                    <button type="button" id="query-submit" class="btn btn-primary">Query Data</button>
                </form>
                <div id="query-results"></div>
            </div>

            <!-- Users Section -->
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                <h2>Users</h2>
                <form action="/add-user/" method="post">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" name="username" class="form-control" id="username">
                    </div>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </form>
                <div id="user-list">
                    <ul class="list-group">
                        <li class="list-group-item">
                            John Doe - johndoe@gmail.com
                            <span class="badge badge-success">Active</span>
                            <button class="btn btn-danger btn-sm float-right">Remove</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- JS for Bootstrap and AJAX Handling -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $('#upload-form').on('submit', function (e) {
            e.preventDefault();  

            var formData = new FormData(this);  
        $('#progress-bar').show();
        $('#progress-bar .progress-bar').css('width', '0%');

        $.ajax({
            xhr: function () {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        var percentComplete = (e.loaded / e.total) * 100;
                        $('#progress-bar .progress-bar').css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            url: $(this).attr('action'),  
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                $('#progress-bar .progress-bar').css('width', '100%');
                alert(response.message);  
            },
            error: function (response) {
                alert('File upload failed!');
            }
        });
    });

    // Load industries into dropdown
    function loadIndustries(offset = 0, limit = 10) {
        $.ajax({
            url: '/api/industry-dropdown/',
            data: { offset: offset, limit: limit },
            success: function (data) {
                const $industrySelect = $('#industry');
                data?.results?.forEach(function (industry) {
                    $industrySelect.append(new Option(industry, industry));
                });
            }
        });
    }

    // Load localities into dropdowns
    function loadLocalities(type) {
        $.ajax({
            url: `/api/locality-dropdown/`,  // Assuming this endpoint provides localities
            data: { type: type },
            success: function (data) {
                const $localitySelect = $('#' + type);  // Select the correct element (city, state, or country)
                $localitySelect.empty();  // Clear any existing options
                $localitySelect.append(new Option(`Select ${type.charAt(0).toUpperCase() + type.slice(1)}`, ""));  // Add default option
    
                // Access the appropriate locality array from the results object
                let localities = [];
                if (type === 'city') {
                    localities = data?.results?.cities || [];
                } else if (type === 'state') {
                    localities = data?.results?.states || [];
                } else if (type === 'country') {
                    localities = data?.results?.countries || [];
                }
    
                // Populate the dropdown with the localities
                localities.forEach(function (locality) {
                    $localitySelect.append(new Option(locality, locality));  // Assuming `locality` is the name
                });
            },
            error: function () {
                console.log(`Failed to load ${type} data`);
            }
        });
    }

    // Handle query form submission
    $('#query-submit').on('click', function () {
        const formData = {};
    
        // Get keyword input value
        const keyword = $('#keyword').val();
        if (keyword) {
            formData.keyword = keyword;
        }
    
        // Get industry dropdown value
        const industry = $('#industry').val();
        if (industry && industry !== 'Select') {
            formData.industry = industry;
        }
    
        // Get year dropdown value
        const year = $('#year').val();
        if (year && year !== 'Select') {
            formData.year = year;
        }
    
        // Get city dropdown value
        const city = $('#city').val();
        if (city && city !== 'Select') {
            formData.city = city;
        }
    
        // Get state dropdown value
        const state = $('#state').val();
        if (state && state !== 'Select') {
            formData.state = state;
        }
    
        // Get country dropdown value
        const country = $('#country').val();
        if (country && country !== 'Select') {
            formData.country = country;
        }
    
        // Get employees_from input value
        const employees_from = $('#employees_from').val();
        if (employees_from) {
            formData.employees_from = employees_from;
        }
    
        // Get employees_to input value
        const employees_to = $('#employees_to').val();
        if (employees_to) {
            formData.employees_to = employees_to;
        }
    
        console.log("formData", formData);
    
        // Make the AJAX request with the filtered formData
        $.ajax({
            url: '/api/query-builder/',
            type: 'GET',
            data: formData,
            success: function (response) {
                $('#query-results').text(`Record Count: ${response.count}`);
            },
            error: function () {
                $('#query-results').text('An error occurred.');
            }
        });
    });

    // Initial load of industries and localities
    loadIndustries();
    loadLocalities('city');
    loadLocalities('state');
    loadLocalities('country');
</script>
</body>
</html>